<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Instructions from API</title>
    <style>
        body { font-family: Arial, Helvetica, sans-serif; padding: 20px; }
        .instruction { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .instruction h2 { margin: 0 0 10px; font-size: 1.2em; }
        .instruction p { margin: 0; }
        hr { border: none; border-top: 1px solid #eee; margin: 30px 0; }
    </style>
</head>
<body>
    <h1>Instructions from API</h1>
    <div id="instructions"></div>
    <!-- 1 The script is loaded with defer so that it runs only after the DOM has been fully parsed. -->
    <script defer>
        async function loadInstructions() {
            try {
                // Get the full query string from the URL
                const queryString = window.location.search;
                // Use URLSearchParams to parse the query string
                const urlParams = new URLSearchParams(queryString);
                // Return the value of the specified parameter
                const group = urlParams.get('group');
                // Define the authentication token
                const authToken = '5fe704861ce1cdca3d0de625d7671de3e1ae80c783e6763b5e50febaa87776fd';
                // Define the request body
                const requestBody = {
                    group_encoded: group
                };
                //2 Make the request to the API endpoint. /
                let response = await fetch('https://apim.workato.com/bostons/test-tatiana-brat-v1/database', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'API-TOKEN': authToken
                    },
                    body: JSON.stringify(requestBody)
                });
                // 3  Parse the JSON payload. /
                if (!response.ok) throw new Error(Network error: ${response.status});
                const rawData = await response.json();
                // 4 Normalise the payload into a single array called instructions. /
                let instructions = [];
                if (Array.isArray(rawData)) {
                    instructions = rawData;
                } else if (rawData && typeof rawData === 'object') {
                    if (Array.isArray(rawData.database)) {
                        instructions = rawData.database;
                    } else if (rawData.database && typeof rawData.database === 'object') {
                        instructions = [rawData.database];
                    } else {
                        instructions = [rawData];
                    }
                }
                if (!Array.isArray(instructions)) {
                    throw new Error('Response is not an array of instructions');
                }
                // 5️  Render each instruction into the DOM. /
                const container = document.getElementById('instructions');
                instructions.forEach((item, idx) => {
                    const name = item.instruction_name ||
                                 item.instruction_item?.instruction_name ||
                                 Instruction ${idx + 1};
                    const rawText = item.instruction ||
                                    item.instruction_item?.instruction ||
                                    'No text found';
                    const text = rawText;
                    const div = document.createElement('div');
                    div.className = 'instruction';
                    // Unique ids
                    const textareaId = myTextArea_${idx};
                    const buttonId = editBtn_${idx};
					div.innerHTML = <h2>${name}</h2><textarea id="${textareaId}" cols="50" rows="10" readonly>${text}</textarea><button id="${buttonId}">Edit</button>;
                    // Adding element to DOM
                    container.appendChild(div);
                    const textarea = document.getElementById(textareaId);
                    const btn = document.getElementById(buttonId);
                    btn.addEventListener('click', () => {
                        const isReadonly = textarea.hasAttribute('readonly');
                        if (isReadonly) {
                            textarea.removeAttribute('readonly');
                            textarea.focus(); // Immediately focus
                            btn.textContent = 'Save';
                        } else {
                            textarea.setAttribute('readonly', true);
                            btn.textContent = 'Edit';
                        }
                    });
                    if (idx < instructions.length - 1) {
                        container.appendChild(document.createElement('hr'));
                    }
                });
            } catch (err) {
                // 6️ If something goes wrong, log the error and show a friendly message. /
                console.error(err);
                document.getElementById('instructions')
                        .innerText = 'Could not load data. Please check the URL or the response format.';
            }
        }
        // 7️  Wait until the DOM is ready before attempting to load instructions. /
        document.addEventListener('DOMContentLoaded', loadInstructions);
    </script>
</body>
</html>